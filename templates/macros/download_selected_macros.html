{% extends 'base.html' %}
{% load static %}

{% block title %}Select Macros - {{ file.name }} - DAW Macros Hub{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-check-square"></i> Select Macros to Download
            </h1>
            <p class="text-muted mb-0">
                Choose specific macros from <strong>{{ file.name }}</strong> to include in your custom download
            </p>
        </div>
        <div>
            <a href="{% url 'macros:keycommands_detail' file.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to File
            </a>
        </div>
    </div>
    
    <!-- File Information -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1">{{ file.name }}</h6>
                    {% if file.description %}
                    <p class="text-muted small mb-0">{{ file.description|truncatechars:100 }}</p>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {% if file.cubase_version %}
                    <small class="text-muted">
                        <i class="fas fa-compact-disc"></i> {{ file.cubase_version.version }}
                    </small>
                    {% endif %}
                </div>
                <div class="col-md-3 text-end">
                    <small class="text-muted">
                        by {{ file.user.username }} â€¢ {{ file.created_at|timesince }} ago
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Selection Form -->
    <form method="post" id="macro-selection-form">
        {% csrf_token %}
        
        <!-- Selection Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="select-all">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all">
                                <i class="fas fa-square"></i> Deselect All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" id="toggle-selection">
                                <i class="fas fa-exchange-alt"></i> Toggle Selection
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-3 text-end">
                        <span class="badge bg-primary" id="selection-count">
                            0 selected
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Macros Selection -->
        {% if macros %}
        <div class="row" id="macros-container">
            {% for macro in macros %}
            <div class="col-lg-6 col-xl-4 mb-3 macro-item">
                <div class="card macro-selection-card">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input macro-checkbox" type="checkbox" 
                                       name="selected_macros" value="{{ macro.id }}" id="macro-{{ macro.id }}">
                                <label class="form-check-label" for="macro-{{ macro.id }}"></label>
                            </div>
                            
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">
                                    {{ macro.name|truncatechars:45 }}
                                </h6>
                                
                                
                                {% if macro.key_binding %}
                                <div class="mb-1">
                                    <span class="key-binding small">
                                        <i class="fas fa-keyboard"></i> {{ macro.key_binding }}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if macro.description %}
                                <p class="card-text text-muted small text-truncate-2">
                                    {{ macro.description }}
                                </p>
                                {% endif %}
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        {% if macro.is_private %}
                                            <span class="badge bg-secondary badge-sm">Private</span>
                                        {% else %}
                                            <span class="badge bg-success badge-sm">Public</span>
                                        {% endif %}
                                    </small>
                                    
                                    {% if not macro.is_private %}
                                    <small class="text-muted">
                                        <i class="fas fa-download"></i> {{ macro.download_count }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Download Actions -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">Download Selected Macros</h6>
                        <small class="text-muted">
                            Create a custom Key Commands file with only your selected macros
                        </small>
                    </div>
                    
                    <div class="col-md-6 text-end">
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="submit" class="btn btn-success" id="download-btn" disabled>
                                <i class="fas fa-download"></i> Download Selected
                                <span class="badge bg-light text-dark ms-1" id="download-count">0</span>
                            </button>
                            
                            <a href="{% url 'macros:download_keycommands' file.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-file-download"></i> Download Full File
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- No Macros -->
        <div class="text-center py-5">
            <i class="fas fa-layer-group fa-4x text-muted mb-4"></i>
            <h3>No macros available</h3>
            <p class="text-muted mb-4">This file doesn't contain any macros that can be selected.</p>
            
            <div class="d-flex gap-2 justify-content-center">
                <a href="{% url 'macros:keycommands_detail' file.id %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Back to File
                </a>
                <a href="{% url 'macros:download_keycommands' file.id %}" class="btn btn-primary">
                    <i class="fas fa-download"></i> Download Full File
                </a>
            </div>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
.macro-selection-card {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}

.macro-selection-card:hover {
    border-color: #007bff;
}

.macro-selection-card.selected {
    border-color: #28a745;
    background-color: rgba(40, 167, 69, 0.05);
}

.form-check-input:checked + .form-check-label + .flex-grow-1 {
    opacity: 1;
}

.macro-item.hidden {
    display: none;
}

.badge-sm {
    font-size: 0.7rem;
}

.text-truncate-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.key-binding {
    font-family: monospace;
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('macro-selection-form');
    const checkboxes = document.querySelectorAll('.macro-checkbox');
    const selectionCount = document.getElementById('selection-count');
    const downloadCount = document.getElementById('download-count');
    const downloadBtn = document.getElementById('download-btn');
    
    // Update selection count and download button state
    function updateSelectionCount() {
        const selectedCount = document.querySelectorAll('.macro-checkbox:checked').length;
        selectionCount.textContent = `${selectedCount} selected`;
        downloadCount.textContent = selectedCount;
        downloadBtn.disabled = selectedCount === 0;
        
        // Update download button text
        if (selectedCount === 0) {
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Selected <span class="badge bg-light text-dark ms-1">0</span>';
        } else {
            downloadBtn.innerHTML = `<i class="fas fa-download"></i> Download Selected <span class="badge bg-light text-dark ms-1">${selectedCount}</span>`;
        }
    }
    
    // Handle individual checkbox changes
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const card = this.closest('.macro-selection-card');
            if (this.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            updateSelectionCount();
        });
    });
    
    // Handle card clicks (toggle checkbox)
    document.querySelectorAll('.macro-selection-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('.macro-checkbox');
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
    });
    
    // Select all button
    document.getElementById('select-all').addEventListener('click', function() {
        const visibleCheckboxes = document.querySelectorAll('.macro-item:not(.hidden) .macro-checkbox');
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
        });
    });
    
    // Deselect all button
    document.getElementById('deselect-all').addEventListener('click', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        });
    });
    
    // Toggle selection button
    document.getElementById('toggle-selection').addEventListener('click', function() {
        const visibleCheckboxes = document.querySelectorAll('.macro-item:not(.hidden) .macro-checkbox');
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        });
    });
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        const selectedCount = document.querySelectorAll('.macro-checkbox:checked').length;
        
        if (selectedCount === 0) {
            e.preventDefault();
            if (window.showToast) {
                showToast('Please select at least one macro to download.', 'warning');
            }
            return false;
        }
        
        // Show loading state
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating File...';
    });
    
    // Initial update
    updateSelectionCount();
});
</script>
{% endblock %} 